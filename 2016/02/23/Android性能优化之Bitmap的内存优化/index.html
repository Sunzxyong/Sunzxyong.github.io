<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Android性能优化之Bitmap的内存优化 | zhengxiaoyong</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="1、BitmapFactory解析Bitmap的原理BitmapFactory提供的解析Bitmap的静态工厂方法有以下五种：
12345Bitmap decodeFile(...)Bitmap decodeResource(...)Bitmap decodeByteArray(...)Bitmap decodeStream(...)Bitmap decodeFileDescriptor(...)">
<meta property="og:type" content="article">
<meta property="og:title" content="Android性能优化之Bitmap的内存优化">
<meta property="og:url" content="http://zhengxiaoyong.me/2016/02/23/Android性能优化之Bitmap的内存优化/index.html">
<meta property="og:site_name" content="zhengxiaoyong">
<meta property="og:description" content="1、BitmapFactory解析Bitmap的原理BitmapFactory提供的解析Bitmap的静态工厂方法有以下五种：
12345Bitmap decodeFile(...)Bitmap decodeResource(...)Bitmap decodeByteArray(...)Bitmap decodeStream(...)Bitmap decodeFileDescriptor(...)">
<meta property="og:image" content="http://7xswxf.com2.z0.glb.clouddn.com/blog/bitmap1.png">
<meta property="og:image" content="http://7xswxf.com2.z0.glb.clouddn.com/blog/bitmap2.png">
<meta property="og:updated_time" content="2016-04-24T05:08:47.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android性能优化之Bitmap的内存优化">
<meta name="twitter:description" content="1、BitmapFactory解析Bitmap的原理BitmapFactory提供的解析Bitmap的静态工厂方法有以下五种：
12345Bitmap decodeFile(...)Bitmap decodeResource(...)Bitmap decodeByteArray(...)Bitmap decodeStream(...)Bitmap decodeFileDescriptor(...)">
  
    <link rel="alternative" href="/atom.xml" title="zhengxiaoyong" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://7xswxf.com2.z0.glb.qiniucdn.com/image/icon.png" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">郑晓勇</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Coding is a wonderful thing.</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/categories/性能优化">性能优化</a></li>
				        
							<li><a href="/categories/技术沉淀">技术沉淀</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/Sunzxyong" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/p/1005053048730677/home?from=page_100505&mod=TAB#place" title="weibo">weibo</a>
					        
								<a class="mail" target="_blank" href="/1175151739@qq.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Bitmap/" style="font-size: 10px;">Bitmap</a> <a href="/tags/Fresco原理/" style="font-size: 10px;">Fresco原理</a> <a href="/tags/JsBridge/" style="font-size: 10px;">JsBridge</a> <a href="/tags/Splash页/" style="font-size: 10px;">Splash页</a> <a href="/tags/UrlRouter/" style="font-size: 10px;">UrlRouter</a> <a href="/tags/WebView/" style="font-size: 10px;">WebView</a> <a href="/tags/WebView安全/" style="font-size: 10px;">WebView安全</a> <a href="/tags/兼容性/" style="font-size: 10px;">兼容性</a> <a href="/tags/内存优化/" style="font-size: 10px;">内存优化</a> <a href="/tags/内存泄露/" style="font-size: 10px;">内存泄露</a> <a href="/tags/启动速度/" style="font-size: 10px;">启动速度</a> <a href="/tags/异步任务/" style="font-size: 10px;">异步任务</a> <a href="/tags/性能优化点/" style="font-size: 10px;">性能优化点</a> <a href="/tags/消费者/" style="font-size: 10px;">消费者</a> <a href="/tags/生产者/" style="font-size: 10px;">生产者</a> <a href="/tags/线程池/" style="font-size: 10px;">线程池</a> <a href="/tags/订阅者/" style="font-size: 10px;">订阅者</a> <a href="/tags/路由框架/" style="font-size: 10px;">路由框架</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://blog.csdn.net/u010687392">我的CSDN的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">2016届毕业的应届生，喜欢Android、喜欢探索新技术、喜欢性能优化、喜欢代码的整洁、喜欢...目前就职于微店。微信：zxy1175151739</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">郑晓勇</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://7xswxf.com2.z0.glb.qiniucdn.com/image/icon.png" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">郑晓勇</h1>
			</hgroup>
			
			<p class="header-subtitle">Coding is a wonderful thing.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/categories/性能优化">性能优化</a></li>
		        
					<li><a href="/categories/技术沉淀">技术沉淀</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/Sunzxyong" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/p/1005053048730677/home?from=page_100505&mod=TAB#place" title="weibo">weibo</a>
			        
						<a class="mail" target="_blank" href="/1175151739@qq.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-Android性能优化之Bitmap的内存优化" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/02/23/Android性能优化之Bitmap的内存优化/" class="article-date">
  	<time datetime="2016-02-23T02:53:30.000Z" itemprop="datePublished">2016-02-23</time>
</a>
	
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android性能优化之Bitmap的内存优化
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Bitmap/">Bitmap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/内存优化/">内存优化</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/性能优化/">性能优化</a>
	</div>


        <div class="clearfix"><span id="busuanzi_container_page_pv">
  	<h5>阅读量<span id="busuanzi_value_page_pv"></span>次</h5>
	</span></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1、BitmapFactory解析Bitmap的原理"><a href="#1、BitmapFactory解析Bitmap的原理" class="headerlink" title="1、BitmapFactory解析Bitmap的原理"></a><strong>1、BitmapFactory解析Bitmap的原理</strong></h2><p>BitmapFactory提供的解析Bitmap的静态工厂方法有以下五种：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Bitmap <span class="function"><span class="title">decodeFile</span><span class="params">(...)</span></span></span><br><span class="line">Bitmap <span class="function"><span class="title">decodeResource</span><span class="params">(...)</span></span></span><br><span class="line">Bitmap <span class="function"><span class="title">decodeByteArray</span><span class="params">(...)</span></span></span><br><span class="line">Bitmap <span class="function"><span class="title">decodeStream</span><span class="params">(...)</span></span></span><br><span class="line">Bitmap <span class="function"><span class="title">decodeFileDescriptor</span><span class="params">(...)</span></span></span><br></pre></td></tr></table></figure>
<p>其中常用的三个：decodeFile、decodeResource、decodeStream。<br>decodeFile和decodeResource其实最终都是调用decodeStream方法来解析Bitmap，decodeStream的内部则是调用两个native方法解析Bitmap的：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">nativeDecodeAsset</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">nativeDecodeStream</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>这两个native方法只是对应decodeFile和decodeResource、decodeStream来解析的，像decodeByteArray、decodeFileDescriptor也有专门的native方法负责解析Bitmap。<br><a id="more"></a><br>接下来就是看看这两个方法在解析Bitmap时究竟有什么区别decodeFile、decodeResource，查看后发现它们调用路径如下：</p>
<blockquote>
<p>decodeFile-&gt;decodeStream<br>decodeResource-&gt;decodeResourceStream-&gt;decodeStream</p>
</blockquote>
<p>decodeResource在解析时多调用了一个<strong>decodeResourceStream</strong>方法，而这个decodeResourceStream方法代码如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeResourceStream</span>(<span class="params">Resources res, TypedValue <span class="keyword">value</span>,</span><br><span class="line">        InputStream <span class="keyword">is</span>, Rect pad, Options opts</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (opts == <span class="keyword">null</span>) &#123;</span><br><span class="line">        opts = <span class="keyword">new</span> Options();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (opts.inDensity == <span class="number">0</span> &amp;&amp; <span class="keyword">value</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">        final <span class="keyword">int</span> density = <span class="keyword">value</span>.density;</span><br><span class="line">        <span class="keyword">if</span> (density == TypedValue.DENSITY_DEFAULT) &#123;</span><br><span class="line">            opts.inDensity = DisplayMetrics.DENSITY_DEFAULT;</span><br><span class="line">        &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">density != TypedValue.DENSITY_NONE</span>) </span>&#123;</span><br><span class="line">            opts.inDensity = density;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (opts.inTargetDensity == <span class="number">0</span> &amp;&amp; res != <span class="keyword">null</span>) &#123;</span><br><span class="line">        opts.inTargetDensity = res.getDisplayMetrics().densityDpi;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> decodeStream(<span class="keyword">is</span>, pad, opts);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它主要是对Options进行处理了，在得到<strong>opts.inDensity</strong>属性的前提下，如果我们没有对该属性设定值，那么将opts.inDensity = DisplayMetrics.DENSITY_DEFAULT;赋定这个默认的Density值，这个默认值为160，为标准的dpi比例，即在Density=160的设备上1dp=1px，这个方法中还有这么一行</p>
<blockquote>
<p>opts.inTargetDensity = res.getDisplayMetrics().densityDpi;</p>
</blockquote>
<p>对<strong>opts.inTargetDensity</strong>进行了赋值，该值为当前设备的densityDpi值，所以说在decodeResourceStream方法中主要做了两件事：</p>
<blockquote>
<p>1、对opts.inDensity赋值，没有则赋默认值160<br>2、对opts.inTargetDensity赋值，没有则赋当前设备的densityDpi值</p>
</blockquote>
<p>之后重点来了，之后参数将传入decodeStream方法，该方法中在调用native方法进行解析Bitmap后会调用这个方法<strong>setDensityFromOptions(bm, opts);</strong>：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">setDensityFromOptions</span><span class="params">(Bitmap outputBitmap, Options opts)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (outputBitmap == <span class="keyword">null</span> || opts == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> density = opts.inDensity;</span><br><span class="line">    <span class="keyword">if</span> (density != <span class="number">0</span>) &#123;</span><br><span class="line">        outputBitmap.setDensity(density);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> targetDensity = opts.inTargetDensity;</span><br><span class="line">        <span class="keyword">if</span> (targetDensity == <span class="number">0</span> || density == targetDensity || density == opts.inScreenDensity) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] np = outputBitmap.getNinePatchChunk();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isNinePatch = np != <span class="keyword">null</span> &amp;&amp; NinePatch.isNinePatchChunk(np);</span><br><span class="line">        <span class="keyword">if</span> (opts.inScaled || isNinePatch) &#123;</span><br><span class="line">            outputBitmap.setDensity(targetDensity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(opts.inBitmap != <span class="keyword">null</span>)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// bitmap was reused, ensure density is reset</span></span><br><span class="line">        outputBitmap.setDensity(Bitmap.getDefaultDensity());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法主要就是把刚刚赋值过的两个属性inDensity和inTargetDensity给Bitmap进行赋值，不过并不是直接赋给Bitmap就完了，中间有个判断，当inDensity的值与inTargetDensity或与设备的屏幕Density不相等时，则将应用inTargetDensity的值，如果相等则应用inDensity的值。</p>
<blockquote>
<p>所以总结来说，<strong>setDensityFromOptions</strong>方法就是把<strong>inTargetDensity</strong>的值赋给Bitmap，不过前提是opts.inScaled = true；</p>
</blockquote>
<p>进过上面的分析，可以得出这样一个结论：</p>
<blockquote>
<p>在不配置Options的情况下：<br>1、decodeFile、decodeStream在解析时不会对Bitmap进行一系列的屏幕适配，解析出来的将是原始大小的图<br>2、decodeResource在解析时会对Bitmap根据当前设备屏幕像素密度densityDpi的值进行缩放适配操作，使得解析出来的Bitmap与当前设备的分辨率匹配，达到一个最佳的显示效果，并且Bitmap的大小将比原始的大</p>
</blockquote>
<h3 id="1-1、关于Density、分辨率、-hdpi等res目录之间的关系"><a href="#1-1、关于Density、分辨率、-hdpi等res目录之间的关系" class="headerlink" title="1.1、关于Density、分辨率、-hdpi等res目录之间的关系"></a><strong>1.1、关于Density、分辨率、-hdpi等res目录之间的关系</strong></h3><table>
<thead>
<tr>
<th>DensityDpi</th>
<th>分辨率</th>
<th>res</th>
<th>Density</th>
</tr>
</thead>
<tbody>
<tr>
<td>160dpi</td>
<td>320x533</td>
<td>mdpi</td>
<td>1</td>
</tr>
<tr>
<td>240dpi</td>
<td>480x800</td>
<td>hdpi</td>
<td>1.5</td>
</tr>
<tr>
<td>320dpi</td>
<td>720x1280</td>
<td>xhdpi</td>
<td>2</td>
</tr>
<tr>
<td>480dpi</td>
<td>1080x1920</td>
<td>xxhdpi</td>
<td>3</td>
</tr>
<tr>
<td>560dpi</td>
<td>1440x2560</td>
<td>xxxhdpi</td>
<td>3.5</td>
</tr>
</tbody>
</table>
<p>dp与px的换算公式为：</p>
<blockquote>
<p>px = dp * Density</p>
</blockquote>
<h3 id="1-2、DisplayMetrics-densityDpi与density的区别"><a href="#1-2、DisplayMetrics-densityDpi与density的区别" class="headerlink" title="1.2、DisplayMetrics::densityDpi与density的区别"></a><strong>1.2、DisplayMetrics::densityDpi与density的区别</strong></h3><blockquote>
<p>getResources().getDisplayMetrics().densityDpi——表示屏幕的像素密度<br>getResources().getDisplayMetrics().density——1dp等于多少个像素(px)</p>
</blockquote>
<p>举个栗子：在屏幕密度为160的设备下，1dp=1px。在屏幕密度为320的设备下，1dp=2px。<br>所以这就为什么在安卓中布局建议使用dp为单位，因为可以根据当前设备的屏幕密度动态的调整进行适配</p>
<h2 id="2、Bitmap的优化策略"><a href="#2、Bitmap的优化策略" class="headerlink" title="2、Bitmap的优化策略"></a><strong>2、Bitmap的优化策略</strong></h2><h3 id="2-1、BitmapFactory-Options的属性解析"><a href="#2-1、BitmapFactory-Options的属性解析" class="headerlink" title="2.1、BitmapFactory.Options的属性解析"></a><strong>2.1、BitmapFactory.Options的属性解析</strong></h3><p>BitmapFactory.Options中有以下属性：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">in</span>Bitmap——在解析Bitmap时重用该Bitmap，不过必须等大的Bitmap而且<span class="keyword">in</span>Mutable须为<span class="literal">true</span></span><br><span class="line"><span class="keyword">in</span>Mutable——配置Bitmap是否可以更改，比如：在Bitmap上隔几个像素加一条线段</span><br><span class="line"><span class="keyword">in</span>JustDecodeBounds——为<span class="literal">true</span>仅返回Bitmap的宽高等属性</span><br><span class="line"><span class="keyword">in</span>SampleSize——须&gt;=<span class="number">1</span>,表示Bitmap的压缩比例，如：<span class="keyword">in</span>SampleSize=<span class="number">4</span>，将返回一个是原始图的<span class="number">1</span>/<span class="number">16</span>大小的Bitmap</span><br><span class="line"><span class="keyword">in</span>PreferredConfig——Bitmap.Config.ARGB_8888等</span><br><span class="line"><span class="keyword">in</span>Dither——是否抖动，默认为<span class="literal">false</span></span><br><span class="line"><span class="keyword">in</span>Premultiplied——默认为<span class="literal">true</span>，一般不改变它的值</span><br><span class="line"><span class="keyword">in</span>Density——Bitmap的像素密度</span><br><span class="line"><span class="keyword">in</span>TargetDensity——Bitmap最终的像素密度</span><br><span class="line"><span class="keyword">in</span>ScreenDensity——当前屏幕的像素密度</span><br><span class="line"><span class="keyword">in</span>Scaled——是否支持缩放，默认为<span class="literal">true</span>，当设置了这个，Bitmap将会以<span class="keyword">in</span>TargetDensity的值进行缩放</span><br><span class="line"><span class="keyword">in</span>Purgeable——当存储Pixel的内存空间在系统内存不足时是否可以被回收</span><br><span class="line"><span class="keyword">in</span>InputShareable——<span class="keyword">in</span>Purgeable为<span class="literal">true</span>情况下才生效，是否可以共享一个InputStream</span><br><span class="line"><span class="keyword">in</span>PreferQualityOverSpeed——为<span class="literal">true</span>则优先保证Bitmap质量其次是解码速度</span><br><span class="line">outWidth——返回的Bitmap的宽</span><br><span class="line">outHeight——返回的Bitmap的高</span><br><span class="line"><span class="keyword">in</span>TempStorage——解码时的临时空间，建议<span class="number">16</span>*<span class="number">1024</span></span><br></pre></td></tr></table></figure>
<h3 id="2-2、优化策略"><a href="#2-2、优化策略" class="headerlink" title="2.2、优化策略"></a><strong>2.2、优化策略</strong></h3><blockquote>
<p><strong>1、BitmapConfig的配置</strong><br><strong>2、使用decodeFile、decodeResource、decodeStream进行解析Bitmap时，配置inDensity和inTargetDensity，两者应该相等,值可以等于屏幕像素密度*0.75f</strong><br><strong>3、使用inJustDecodeBounds预判断Bitmap的大小及使用inSampleSize进行压缩</strong><br><strong>4、对Density&gt;240的设备进行Bitmap的适配（缩放Density）</strong><br><strong>5、2.3版本inNativeAlloc的使用</strong><br><strong>6、4.4以下版本inPurgeable、inInputShareable的使用</strong><br><strong>7、Bitmap的回收</strong></p>
</blockquote>
<p>针对上面方案，把Bitmap解码的代码封装成了一个工具类，如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BitmapDecodeUtil</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> final <span class="keyword">int</span> DEFAULT_DENSITY = <span class="number">240</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> final <span class="keyword">float</span> SCALE_FACTOR = <span class="number">0.75</span>f;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> final Bitmap.Config DEFAULT_BITMAP_CONFIG = Bitmap.Config.RGB_565;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> BitmapFactory.<span class="function">Options <span class="title">getBitmapOptions</span>(<span class="params">Context context</span>) </span>&#123;</span><br><span class="line">        BitmapFactory.Options options = <span class="keyword">new</span> BitmapFactory.Options();</span><br><span class="line">        options.inScaled = <span class="keyword">true</span>;</span><br><span class="line">        options.inPreferredConfig = DEFAULT_BITMAP_CONFIG;</span><br><span class="line">        options.inPurgeable = <span class="keyword">true</span>;</span><br><span class="line">        options.inInputShareable = <span class="keyword">true</span>;</span><br><span class="line">        options.inJustDecodeBounds = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.GINGERBREAD_MR1) &#123;</span><br><span class="line">            Field field = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                field = BitmapFactory.Options.class.getDeclaredField(<span class="string">"inNativeAlloc"</span>);</span><br><span class="line">                field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                field.setBoolean(options, <span class="keyword">true</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> displayDensityDpi = context.getResources().getDisplayMetrics().densityDpi;</span><br><span class="line">        <span class="keyword">float</span> displayDensity = context.getResources().getDisplayMetrics().density;</span><br><span class="line">        <span class="keyword">if</span> (displayDensityDpi &gt; DEFAULT_DENSITY &amp;&amp; displayDensity &gt; <span class="number">1.5</span>f) &#123;</span><br><span class="line">            <span class="keyword">int</span> density = (<span class="keyword">int</span>) (displayDensityDpi * SCALE_FACTOR);</span><br><span class="line">            options.inDensity = density;</span><br><span class="line">            options.inTargetDensity = density;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> options;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeBitmap</span>(<span class="params">Context context, <span class="keyword">int</span> resId</span>) </span>&#123;</span><br><span class="line">        checkParam(context);</span><br><span class="line">        <span class="keyword">return</span> BitmapFactory.decodeResource(context.getResources(), resId, getBitmapOptions(context));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeBitmap</span>(<span class="params">Context context, String pathName</span>) </span>&#123;</span><br><span class="line">        checkParam(context);</span><br><span class="line">        <span class="keyword">return</span> BitmapFactory.decodeFile(pathName, getBitmapOptions(context));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">decodeBitmap</span>(<span class="params">Context context, InputStream <span class="keyword">is</span></span>) </span>&#123;</span><br><span class="line">        checkParam(context);</span><br><span class="line">        checkParam(<span class="keyword">is</span>);</span><br><span class="line">        <span class="keyword">return</span> BitmapFactory.decodeStream(<span class="keyword">is</span>, <span class="keyword">null</span>, getBitmapOptions(context));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">compressBitmap</span>(<span class="params">Context context,<span class="keyword">int</span> resId, <span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight</span>) </span>&#123;</span><br><span class="line">        checkParam(context);</span><br><span class="line">        final TypedValue <span class="keyword">value</span> = <span class="keyword">new</span> TypedValue();</span><br><span class="line">        InputStream <span class="keyword">is</span> = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">is</span> = context.getResources().openRawResource(resId, <span class="keyword">value</span>);</span><br><span class="line">            <span class="keyword">return</span> compressBitmap(context, <span class="keyword">is</span>, maxWidth, maxHeight);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">is</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">is</span>.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">compressBitmap</span>(<span class="params">Context context, String pathName, <span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight</span>) </span>&#123;</span><br><span class="line">        checkParam(context);</span><br><span class="line">        InputStream <span class="keyword">is</span> = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">is</span> = <span class="keyword">new</span> FileInputStream(pathName);</span><br><span class="line">            <span class="keyword">return</span> compressBitmap(context, <span class="keyword">is</span>, maxWidth, maxHeight);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">is</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">is</span>.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">compressBitmap</span>(<span class="params">Context context, InputStream <span class="keyword">is</span>, <span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight</span>) </span>&#123;</span><br><span class="line">        checkParam(context);</span><br><span class="line">        checkParam(<span class="keyword">is</span>);</span><br><span class="line">        BitmapFactory.Options opt = <span class="keyword">new</span> BitmapFactory.Options();</span><br><span class="line">        opt.inJustDecodeBounds = <span class="keyword">true</span>;</span><br><span class="line">        BitmapFactory.decodeStream(<span class="keyword">is</span>, <span class="keyword">null</span>, opt);</span><br><span class="line">        <span class="keyword">int</span> height = opt.outHeight;</span><br><span class="line">        <span class="keyword">int</span> width = opt.outWidth;</span><br><span class="line">        <span class="keyword">int</span> sampleSize = computeSampleSize(width, height, maxWidth, maxHeight);</span><br><span class="line">        BitmapFactory.Options options = getBitmapOptions(context);</span><br><span class="line">        options.inSampleSize = sampleSize;</span><br><span class="line">        <span class="keyword">return</span> BitmapFactory.decodeStream(<span class="keyword">is</span>, <span class="keyword">null</span>, options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">computeSampleSize</span>(<span class="params"><span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> inSampleSize = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (height &gt; maxHeight || width &gt; maxWidth) &#123;</span><br><span class="line">            final <span class="keyword">int</span> heightRate = Math.round((<span class="keyword">float</span>) height / (<span class="keyword">float</span>) maxHeight);</span><br><span class="line">            final <span class="keyword">int</span> widthRate = Math.round((<span class="keyword">float</span>) width / (<span class="keyword">float</span>) maxWidth);</span><br><span class="line">            inSampleSize = heightRate &lt; widthRate ? heightRate : widthRate;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (inSampleSize % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">            inSampleSize -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> inSampleSize &lt;= <span class="number">1</span> ? <span class="number">1</span> : inSampleSize;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">checkParam</span>(<span class="params">T param</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(param == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要有两类方法：<br>一、decodeBitmap:对Bitmap不压缩，但是会根据屏幕的密度合适的进行缩放压缩<br>二、compressBimtap:对Bitmap进行超过最大宽高的压缩，同时也会根据屏幕的密度合适的进行缩放压缩。</p>
<h2 id="3、Bitmap优化前后性能对比"><a href="#3、Bitmap优化前后性能对比" class="headerlink" title="3、Bitmap优化前后性能对比"></a><strong>3、Bitmap优化前后性能对比</strong></h2><p>针对上面方案，做一下性能对比,图片大小为3.26M,分辨率为2048*2048<br>有两台设备：</p>
<h3 id="3-1、density为320的设备"><a href="#3-1、density为320的设备" class="headerlink" title="3.1、density为320的设备"></a><strong>3.1、density为320的设备</strong></h3><p><img src="http://7xswxf.com2.z0.glb.clouddn.com/blog/bitmap1.png" alt="这里写图片描述"></p>
<h3 id="3-2、density为560的设备"><a href="#3-2、density为560的设备" class="headerlink" title="3.2、density为560的设备"></a><strong>3.2、density为560的设备</strong></h3><p><img src="http://7xswxf.com2.z0.glb.clouddn.com/blog/bitmap2.png" alt="这里写图片描述"></p>
<p>可以看到，都是加载同一图片，在高屏幕像素密度的设备下所需要的内存需要很大、载入内存中的Bitmap的宽高也因设备的屏幕像素密度也改变，正如上面分析的一样，使用decodeResource会自动适配当前设备的分辨率达到一个最佳效果，而只有这个方法会自动适配其它方法将不会，依次思路，我们在封装的工具类中在每一个方法都加入了依屏幕像素密度来自动适配，而在实际中并不需要那么高清的图片，所以我们可以根据设备的density来进行缩放，比如：在400&gt;=density&gt;240的情况下x0.8,在density&gt;400的情况下x0.7，这样Bitmap所占用的内存将减少非常多，可以对面上面两个图片中bitmap和decodeBitmap两个值的大小，decodeBitmap只是对density进行了一定的缩放，而占用内存却减少非常多，而且显示效果也和原先的并无区别。<br>之后对比我们进行了inSampleSize压缩的图片，进行压缩后的效果也看不出太大区别，而占用内存也减少了很多。</p>
<h2 id="4、Bitmap的回收"><a href="#4、Bitmap的回收" class="headerlink" title="4、Bitmap的回收"></a><strong>4、Bitmap的回收</strong></h2><h3 id="4-1、Android-2-3-3-API-10-及以下的系统"><a href="#4-1、Android-2-3-3-API-10-及以下的系统" class="headerlink" title="4.1、Android 2.3.3(API 10)及以下的系统"></a><strong>4.1、Android 2.3.3(API 10)及以下的系统</strong></h3><p>在2.3以下的系统中，Bitmap的像素数据是存储在native中，Bitmap对象是存储在java堆中的，所以在回收Bitmap时，需要回收两个部分的空间：native和java堆。<br>即先调用recycle()释放native中Bitmap的像素数据，再对Bitmap对象置null，保证GC对Bitmap对象的回收</p>
<h3 id="4-2、Android-3-0-API-11-及以上的系统"><a href="#4-2、Android-3-0-API-11-及以上的系统" class="headerlink" title="4.2、Android 3.0(API 11)及以上的系统"></a><strong>4.2、Android 3.0(API 11)及以上的系统</strong></h3><p>在3.0以上的系统中，Bitmap的像素数据和对象本身都是存储在java堆中的，无需主动调用recycle()，只需将对象置null，由GC自动管理</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/04/20/Native与H5交互的那些事/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          Native与H5交互的那些事
        
      </div>
    </a>
  
  
    <a href="/2016/01/27/关于生产者-消费者-订阅者模式的那些事/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">关于生产者-消费者-订阅者模式的那些事</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="Android性能优化之Bitmap的内存优化" data-title="Android性能优化之Bitmap的内存优化" data-url="http://zhengxiaoyong.me/2016/02/23/Android性能优化之Bitmap的内存优化/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  <div class="outer">
	<div class="footer-center”>
		<span id="busuanzi_container_site_pv">
    		<h4>您是本站的第<span id="busuanzi_value_site_pv"></span>位访客</h4>
		</span>
	</div>
    <div id="footer-info">
    	<div class="footer-right”>
    		&copy; 2016 郑晓勇
    	</div>
    </div>
  </div>

</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>